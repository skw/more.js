#!/usr/bin/env node

/*
 #  ##############################
 #
 #    more.js CLI
 #
 #  ##############################
 */


/*
 #  module dependencies
 */

var program = require('commander'),
  pkg = require('../package.json'),
  fs = require('fs'),
  more = require('../index.js');

/*
 #  options
 */

program
  .version(pkg.version)
  .option('-f, --format', 'set format, defaults to styl')
  .option('--styl', 'exports to styl (default)')
  .option('--stylus', 'exports to stylus')
  .option('-m, --merge', 'merge @includes')
  .parse(process.argv);

var options = {};
options.whitespace = program.whitespace;
options.merge = program.merge;

console.log(program.args);


function process(arg){
  fs.readFile(arg, function (err, data) {
    if (err) throw err;
      more( data, function( err, res) {
      if( err ) {
       return false;
      }
      fs.writeFile( "./obj.json", JSON.stringify( res, null, 2 ), function( err ) {
         if( err ) {
             console.log( err );
         } else {
             console.log( "The file was saved!" );
         }
      }); 
    });
  });  
}

// iterate over args
for(var i = 0; i < program.args.length; i++) {
  console.log('checking for ' + program.args[i]);
  var arg = program.args[i]
  // check if arg exists
  fs.exists(arg, function (exists) {
    if (exists) {
      fs.stat( arg, function ( err, ring ) {
        if ( ring.isDirectory() ){
         
        } else if ( ring.isFile() ) {
          process( arg );
  
        } else {
          console.warn( '"%s" type is not accepted', arg);
        }
      });
      console.log( 'YES');
    } else {
      console.warn( '"%s" does not exists', arg);
    }
  });
}